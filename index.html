<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>
    (function () {
      try {
        const savedTheme = localStorage.getItem("studyai-theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        const theme = savedTheme || (prefersDark ? "dark" : "light");
        document.documentElement.setAttribute("data-theme", theme);
      } catch (e) {
        // fallback if localStorage is blocked
        document.documentElement.setAttribute("data-theme", "dark");
      }
    })();
  </script>
  
  <title>Passing Grade</title>
   <!-- Tell Safari/Chrome we support both themes -->
  <meta name="color-scheme" content="light dark" />

  <!-- Browser / status bar color (will be updated by JS) -->
  <meta name="theme-color" content="#020617" id="meta-theme-color" />

  <!-- Optional iOS standalone app styling -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passing Grade</title>

  <!-- Google Fonts + Material Icons -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;600;700&family=DM+Sans:wght@400;500;600&family=Material+Symbols+Outlined:wght@400&display=swap"
  />
<link rel="icon" href="favicon.png" />
<link rel="icon" type="image/png" href="favicon.png" />
<link rel="apple-touch-icon" href="icon.png" />
<style>
  :root {
    /* Neutral, gender-balanced indigo/sky palette */
    --primary: #6366f1;           /* indigo */
    --primary-variant: #0ea5e9;   /* sky */
    --on-primary: #ffffff;

    --surface-dark: #020617;      /* page background dark */
    --surface-light: #e5e7eb;     /* page background light */
    --surface-elevated-dark: #0b1020;
    --surface-elevated-light: #ffffff;

    --on-surface-dark: #e5e7eb;
    --on-surface-light: #020617;

    --outline-dark: rgba(148, 163, 184, 0.3);
    --outline-light: rgba(15, 23, 42, 0.12);

    --radius-lg: 18px;
    --radius-md: 12px;
    --transition-fast: 0.16s ease-out;
  }

  [data-theme="dark"] {
    --surface: var(--surface-dark);
    --card-bg: var(--surface-elevated-dark);
    --on-surface: var(--on-surface-dark);
    --outline: var(--outline-dark);
    --field-bg: rgba(15, 23, 42, 0.95);
    --chip-bg: #020617;
    --code-bg: #ffffff; /* white outputs */
    --code-fg: #020617;
    --muted: #9ca3af;
    --header-bg: radial-gradient(circle at top left, #111827, #020617);
    --sidebar-bg: #020617;
  }

  [data-theme="light"] {
    /* page slightly darker than white, cards + outputs white */
    --surface: var(--surface-light);
    --card-bg: var(--surface-elevated-light);
    --on-surface: var(--on-surface-light);
    --outline: var(--outline-light);
    --field-bg: #f9fafb;
    --chip-bg: #eef2ff;
    --code-bg: #ffffff; /* white outputs */
    --code-fg: #020617;
    --muted: #6b7280;
    --header-bg: #f9fafb;
    --sidebar-bg: #f9fafb;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont,
      sans-serif;
    background: var(--surface);
    color: var(--on-surface);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding-top: 0.75rem;
  }

  .app {
    width: 100%;
    max-width: 980px;
    min-height: 100vh;
    padding: 14px 14px 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  header {
    background: var(--header-bg);
    border-radius: 20px;
    padding: 19px 14px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .title-block {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .title-block h1 {
    margin: 0;
    font-family: "Outfit", system-ui;
    font-size: 1.4rem;
    letter-spacing: 0.02em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Show correct logo per theme */
  html[data-theme="light"] .brand-logo-light { display: block; }
  html[data-theme="light"] .brand-logo-dark  { display: none; }

  html[data-theme="dark"] .brand-logo-light { display: none; }
  html[data-theme="dark"] .brand-logo-dark  { display: block; }

  /* logo container */
  .brand-logo-wrap {
    display: flex;
    align-items: center;
    flex: 0 1 auto;
  }

  /* main logo image (use your new horizontal logo here) */
  .brand-logo {
    display: block;
    height: 70px;
    width: auto;
  }

  /* tagline under the logo/header */
  .header-subline {
    margin-top: 0.35rem;
    font-size: 0.9rem;
    line-height: 1.4;
    color: #4b5563;
  }

  .header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
  }

  .header-top-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ---- Auth status + sign-in button ---- */
  .auth-row {
    margin-top: 4px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .user-plan-label {
    white-space: nowrap;
  }

  .auth-button {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    padding: 6px 12px;
    font-size: 0.78rem;
    background: transparent;
    color: var(--on-surface);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: none;
  }

  .auth-button:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.08);
  }

  .chip {
    font-size: 0.74rem;
    padding: 5px 12px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    background: var(--chip-bg);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 7px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }

  .chip-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 6px rgba(34, 197, 94, 0.7);
  }

  .theme-toggle,
  .drawer-toggle {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 7px 13px;
    background: var(--card-bg);   /* follows light/dark theme */
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.78rem;
    color: var(--on-surface);     /* readable on both themes */
    cursor: pointer;
    transition:
      border-color var(--transition-fast),
      color var(--transition-fast),
      background var(--transition-fast),
      transform 0.08s ease-out;
  }

  .theme-toggle svg {
    width: 18px;
    height: 18px;
  }

  .drawer-toggle .material-symbols-outlined {
    font-size: 20px;
  }

  .theme-toggle:hover,
  .drawer-toggle:hover {
    border-color: transparent;
    background: linear-gradient(135deg, var(--primary), var(--primary-variant));
    color: var(--on-primary);
    transform: translateY(-1px);
  }

  .top-bar {
    display: flex;
    gap: 8px;
    margin: 2px 0 4px;
	
  }

  select {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: var(--card-bg);
    color: var(--on-surface);
    font-size: 0.8rem;
    padding: 7px 10px;
    outline: none;
  }

  .top-bar select {
    flex: 1;
  }

  .main-layout {
    display: flex;
    gap: 12px;
    flex: 1;
    min-height: 0;
    margin-top: 4px;
  }

  .content {
    flex: 1;
    min-width: 0;
  }

  .card {
    background: var(--card-bg);
    border-radius: 18px;
    border: 1px solid var(--outline);
    padding: 14px;
    margin-bottom: 10px;
  }

  .card h2 {
    margin: 0 0 4px;
    font-family: "Outfit", system-ui;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.01em;
  }

  .desc {
    margin: 0 0 10px;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  label {
    display: block;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 4px;
  }

  textarea,
  input[type="file"] {
    width: 100%;
    font-family: inherit;
    font-size: 0.9rem;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: var(--field-bg);
    color: var(--on-surface);
    outline: none;
    resize: vertical;
    min-height: 120px;
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast),
      background var(--transition-fast);
  }

  input[type="file"] {
    min-height: auto;
    padding: 8px;
    cursor: pointer;
    font-size: 0.8rem;
  }

  textarea:focus,
  input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
    background: #ffffff05;
  }

  .btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 9px;
    margin-bottom: 4px;
    justify-content: flex-end;
  }

  button {
    border-radius: 999px;
    border: none;
    padding: 9px 16px;
    font-size: 0.85rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: linear-gradient(
      135deg,
      var(--primary),
      var(--primary-variant)
    );
    color: var(--on-primary);
    transition:
      transform 0.08s ease-out,
      box-shadow 0.08s ease-out,
      opacity 0.08s,
      background 0.12s ease-out;
    font-weight: 500;
  }

  button.secondary {
    background: transparent;
    color: var(--on-surface);
    box-shadow: none;
    border: 1px solid rgba(148, 163, 184, 0.7);
  }

  button:active {
    transform: translateY(1px) scale(0.99);
    opacity: 0.96;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
  }

  .hint-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
	justify-content: flex-end;
  }

  .hint-row button {
    font-size: 0.76rem;
    padding: 6px 11px;
  }

  pre {
    margin-top: 8px;
    background: var(--code-bg);  /* white */
    color: var(--code-fg);
    border-radius: 14px;
    padding: 14px 16px;
    font-size: 0.9rem;
    line-height: 1.6;
    max-height: 260px;
    overflow: auto;
    border: 1px solid rgba(148, 163, 184, 0.4);
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Emphasize key lines inside outputs */
  pre .step-line {
    display: block;
    font-weight: 700;
    margin: 6px 0 2px;
  }

  pre .answer-label {
    font-weight: 600;
  }

  pre .answer-value {
    font-weight: 700;
  }

  pre .hint-label {
    display: block;
    margin-top: 10px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.8;
  }

  pre .section-heading {
    display: block;
    margin-top: 10px;
    margin-bottom: 4px;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .pill-button {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    padding: 6px 11px;
    font-size: 0.76rem;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .pill-button.active {
    border-color: var(--primary);
    color: var(--on-surface);
    background: rgba(99, 102, 241, 0.08);
  }

  .material-symbols-outlined {
    font-family: "Material Symbols Outlined";
    font-weight: normal;
    font-style: normal;
    font-size: 20px;
    line-height: 1;
    letter-spacing: normal;
    text-transform: none;
    display: inline-block;
    white-space: nowrap;
    word-wrap: normal;
    direction: ltr;
    -webkit-font-feature-settings: "liga";
    -webkit-font-smoothing: antialiased;
    font-variation-settings:
      "FILL" 0,
      "wght" 400,
      "GRAD" 0,
      "opsz" 24;
  }

  .hint-footer {
    margin-top: 8px;
    font-size: 0.7rem;
    color: var(--muted);
    text-align: left;
  }

  .notebook-item {
    padding: 8px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    margin-bottom: 6px;
    font-size: 0.8rem;
    background: rgba(15, 23, 42, 0.3);
    line-height: 1.5;
  }

  [data-theme="light"] .notebook-item {
    background: #f9fafb;
  }

  .notebook-item small {
    display: block;
    color: var(--muted);
    margin-bottom: 2px;
    font-size: 0.7rem;
  }

  .notebook-item-header {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    margin-bottom: 6px;
  }

  .notebook-meta {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    font-weight: 600;
    color: var(--primary);
  }

  .notebook-actions {
    display: inline-flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .notebook-actions button {
    box-shadow: none;
    padding: 3px 8px;
    font-size: 0.7rem;
  }

  /* The actual saved text body */
  .notebook-item > div:last-child {
    font-size: 0.82rem;
    color: var(--on-surface);
    white-space: pre-wrap;
  }

 .flashcard {
  margin-top: 8px;
  padding: 14px 12px;
  border-radius: 14px;
  border: 1px solid var(--outline);
  background: var(--field-bg);
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;       /* center content inside the card */
}

.flashcard-side {
  font-size: 0.9rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  width: 100%;
  line-height: 1.6;
  text-align: center;       /* center front/back text */
}

/* Flashcards: make questions and answers visually different */
#cardsStats {
  font-size: 0.78rem;
  margin-bottom: 6px;
  opacity: 0.85;
  text-align: center;       /* center stats line */
}

#cardsCard.flashcard {
  border-width: 1px;
  padding: 5em 1em;
}

/* Question side (front) */
#cardsFront {
  font-weight: 700;
  color: var(--primary-variant);
  font-size: 1.02em;
}

/* Answer side (back) */
#cardsBack {
  font-weight: 500;
  color: var(--on-surface);
  opacity: 1;
}


  .side-drawer {
    width: 220px;
    background: var(--sidebar-bg);
    border-left: 1px solid rgba(148, 163, 184, 0.5);
    border-radius: 20px 0 0 20px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.45);
    position: fixed;
    top: 10px;
    right: 10px;
    height: calc(100vh - 20px);
    transform: translateX(110%);
    transition: transform 0.18s ease-out;
    z-index: 30;
    display: flex;
    flex-direction: column;
  }

  .side-drawer.open {
    transform: translateX(0);
  }

  .side-drawer-inner {
    padding: 12px 10px 10px;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .side-drawer-header {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: var(--muted);
    margin-bottom: 6px;
    padding: 0 6px;
  }

  .side-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
    padding-right: 4px;
    margin-top: 2px;
  }

  .nav-btn {
    border-radius: 999px;
    border: none;
    background: transparent;
    color: var(--muted);
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 9px;
    padding: 9px 12px;
    cursor: pointer;
    text-align: left;
    transition:
      background var(--transition-fast),
      color var(--transition-fast),
      transform 0.06s ease-out;
  }

  .nav-btn .material-symbols-outlined {
    font-size: 20px;
  }

  .nav-btn span.label {
    flex: 1;
  }

  .nav-btn.active {
    background: linear-gradient(
      135deg,
      var(--primary),
      var(--primary-variant)
    );
    color: var(--on-primary);
    border: none;
  }

  .drawer-backdrop.show {
    display: block;
  }

  @media (min-width: 800px) {
    .app {
      padding-bottom: 18px;
    }

    .main-layout {
      display: flex;
    }

    .side-drawer {
      position: static;
      height: auto;
      transform: none !important;
      box-shadow: none;
      border-radius: 18px;
      max-height: none;
      width: 230px;
    }

    .side-drawer-inner {
      height: auto;
      max-height: calc(100vh - 120px);
    }

    .drawer-backdrop {
      display: none !important;
    }

    .drawer-toggle {
      display: none;
    }
  }

  [data-theme="light"] .side-drawer {
    background: #ffffff;
  }

  [data-theme="light"] .side-nav .nav-btn {
    background: #ffffff;
    border: 1px solid rgba(148, 163, 184, 0.4);
    color: var(--on-surface);
  }

  [data-theme="light"] .side-nav .nav-btn.active,
  [data-theme="dark"] .side-nav .nav-btn.active {
    background: linear-gradient(
      135deg,
      var(--primary),
      var(--primary-variant)
    );
    color: var(--on-primary);
    border: none;
  }

  [data-theme="dark"] .side-nav .nav-btn {
    background: #0f172a;
    border: 1px solid rgb(55 65 81);
    color: var(--on-surface);
  }
  .mobile-break {
  display: none;
}

 @media (max-width: 700px) {
  /* make header a positioning parent */
  header {
    position: relative;
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
    padding: 16px 12px 12px;
  }
.mobile-break {
    display: inline;
  }
  .title-block {
    width: 100%;
  }

  .title-row {
    justify-content: flex-start;
  }

  .brand-logo {
    display: block;
    height: 45px;
    width: auto;
  }

  .brand-logo-wrap {
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
    background: transparent;
    box-shadow: none;
    height: auto;
	margin-top: .8em;
  }

  .subtitle {
    font-size: 0.85rem;
    color: var(--muted);

  }

  /* left side: guest / plan + buttons */
  .header-right {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 4px;
    padding-top: 10px;   /* ‚Üê was 42px, make this 0‚Äì12px */
  }

  .auth-row {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
    gap: 6px;
    font-size: 0.75rem;
  }

  #userPlanLabel {
    flex: 1 1 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
    line-height: 1.3;
  }

  .btn-upgrade,
  #authButton {
    flex: 0 0 auto;
    padding: 5px 12px;
    font-size: 0.78rem;
    width: auto !important;
    min-width: 0;
  }

  /* üîπ controls pinned to very top-right of header */
  .header-top-row {
    position: absolute;
    top: 16px;          /* roughly level with top of logo text */
    right: 16px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
  }

  .chip.learn-mode {
    flex: 0 0 auto;
    padding: 4px 10px;
    font-size: 0.74rem;
    white-space: nowrap;
  }

  .theme-toggle,
  .drawer-toggle {
    flex: 0 0 auto;
    padding: 6px;
    min-width: 40px;
    justify-content: center;
    font-size: 0.8rem;
  }

  .theme-toggle span#themeLabel {
    display: none;
  }

  .drawer-toggle span:not(.material-symbols-outlined) {
    display: none;
  }

  [data-theme="light"] .brand-logo {
    filter: drop-shadow(0 6px 14px rgba(148, 163, 184, 0.6));
  }

  [data-theme="dark"] .brand-logo {
    filter:
      brightness(1.08)
      drop-shadow(0 0 12px rgba(59, 130, 246, 0.4));
  }
}


  /* ---- Subtle "completed" pulse animation ---- */
  @keyframes pulse-highlight {
    0% {
      box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
      transform: scale(1);
    }
    35% {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.35);
      transform: scale(1.01);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
      transform: scale(1);
    }
  }

  .pulse-once {
    animation: pulse-highlight 0.7s ease-out;
  }
  /* Base (optional tweak if you want) */
.notebook-filter {
  opacity: 0.85;
}
/* Active notebook filter = highlighted */
.notebook-filter.active {
  background: var(--primary-soft, rgba(59,130,246,0.12));
  color: var(--primary, #3b82f6);
  border-color: var(--primary, #3b82f6);
  opacity: 1;
  box-shadow: 0 0 0 1px rgba(59,130,246,0.4);
}

/* Make the icon match the text when active */
.notebook-filter.active .material-symbols-outlined {
  color: inherit;
}

/* Layout for each subject row */
.notebook-subject-row {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 4px;
}

/* Subject chip: primary pill style */
.notebook-subject-btn {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--outline);
  background: var(--field-bg);
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
}

/* Active subject stands out */
.notebook-subject-btn.active {
  border-color: var(--primary, #3b82f6);
  background: rgba(59, 130, 246, 0.12);
  color: var(--primary, #3b82f6);
}

/* Little three-dot menu next to subject chip */
.notebook-subject-menu {
  padding: 2px 8px;
  min-width: auto;
}

/* Base edit/delete style (hidden by default) */
.notebook-subject-edit,
.notebook-subject-delete {
  display: none;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: transparent;
  font-size: 0.7rem;
  opacity: 0.7;
  cursor: pointer;
}

/* Dropdown container */
.notebook-subject-dropdown {
  display: none;             /* JS toggles this */
  position: absolute;
  right: 0;
  top: 110%;
  background: var(--surface);
  border: 1px solid var(--outline);
  border-radius: 10px;
  padding: 6px;
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
  z-index: 30;
  min-width: 170px;
  display: none;
  flex-direction: column;    /* üîπ stack buttons */
  gap: 6px;                  /* space between them */
}

/* Subject dropdown buttons: same width, look like two pills */
.notebook-subject-dropdown .notebook-subject-edit,
.notebook-subject-dropdown .notebook-subject-delete {
  display: flex;
  width: 100%;
  justify-content: flex-start;
  font-size: 0.78rem;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: #ededed;
  gap: 6px;
}

/* Edit = neutral */
.notebook-subject-edit {
  color: var(--on-surface, #0f172a);
}

/* Delete = red text */
.notebook-subject-delete {
  color: #dc2626;
}

/* Hover states */
.notebook-subject-edit:hover,
.notebook-subject-delete:hover {
  opacity: 1;
  border-color: var(--outline-soft, rgba(148, 163, 184, 0.5));
  background: #ffffff;
}
#saveSubjectInput {
  width: 100%;
  font-family: inherit;
  font-size: 0.9rem;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.6);
  background: var(--field-bg);
  color: var(--on-surface);
  outline: none;
  transition:
    border-color var(--transition-fast),
    box-shadow var(--transition-fast),
    background var(--transition-fast);
}



</style>

</head>


<body>
  <div class="app">
<header>
  <div class="title-block">
    <div class="title-row">
      <div class="brand-logo-wrap">
        <img
          src="studylens-light.png"
          class="brand-logo brand-logo-light"
          alt="StudyLens"
        />
        <img
          src="studylens-dark-highvis.png"
          class="brand-logo brand-logo-dark"
          alt="StudyLens"
        />
      </div>
      <h1 class="visually-hidden">StudyLens</h1>
    </div>
    <div class="subtitle">
Snap, solve, study & write.<span class="mobile-break"><br></span> Built for students.
    </div>
  </div>

   <div class="header-right">
    <!-- Row 1: plan + Sign in/out (top-right) -->
    <div class="auth-row">
      <span id="userPlanLabel">Guest ¬∑ 5 free OCR scans</span>

      <button id="upgradeButton" class="btn-upgrade">
        Upgrade to Pro
      </button>
<!-- Optional: something to show when they‚Äôre Pro -->
<span id="proBadge" style="display:none; font-weight:bold;">
  Pro account ‚úÖ
</span>
      <button id="authButton">Sign in</button>
    </div>

    <!-- Row 2: Learn mode toggle + theme + Tools -->
    <div class="header-top-row">
      <!-- Learn mode toggle chip (now acts like a switch) -->
      <div class="chip learn-mode" id="modeChip">
        <span class="chip-dot"></span>
        <span class="mode-label">Learn mode ON</span>
      </div>

      <button class="theme-toggle" id="themeToggle" type="button">
        <svg id="iconSun" viewBox="0 0 24 24">
          <path
            fill="currentColor"
            d="M12 4a1 1 0 0 1 1 1V6a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Zm0 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm8-4a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1ZM6 13a1 1 0 1 1 0-2H5a1 1 0 1 1 0 2h1Zm11.07-5.07a1 1 0 0 1-1.41 0L14.9 7.17a1 1 0 0 1 1.42-1.41l.76.76a1 1 0 0 1 0 1.41Zm-9.54 9.54a1 1 0 0 1-1.41 0l-.76-.76A1 1 0 0 1 6.24 15.3l.76.76a1 1 0 0 1 0 1.41ZM18 17.24a1 1 0 0 1 0-1.41l.76-.76a1 1 0 1 1 1.41 1.41l-.76.76a1 1 0 0 1-1.41 0ZM6.24 8.7a1 1 0 0 1-1.41-1.41l.76-.76A1 1 0 0 1 7 7.24l-.76.76Z"
          />
        </svg>
        <svg id="iconMoon" viewBox="0 0 24 24" style="display: none">
          <path
            fill="currentColor"
            d="M20.3 14.8A7.5 7.5 0 0 1 11.2 3.7 1 1 0 0 0 10 2.49 9.5 9.5 0 1 0 21.51 14a1 1 0 0 0-1.21-1.22Z"
          />
        </svg>
        <span id="themeLabel">Dark</span>
      </button>

      <button class="drawer-toggle" id="drawerToggle" type="button">
        <span class="material-symbols-outlined">view_sidebar</span>
        <span>Tools</span>
      </button>
    </div>
  </div>

</header>


    <div class="top-bar">
  <select id="subjectSelect">
    <option value="general">Subject: Auto</option>
    <option value="math">Math</option>
    <option value="science">Science</option>
    <option value="english">English</option>
    <option value="history">History</option>
  </select>

  <!-- Single model option, still uses value="smart" so backend stays the same -->
  <select id="modelSelect">
    <option value="smart">Model: OpenAI (smart auto)</option>
  </select>
</div>

<p class="desc" style="margin: 4px 0 0; font-size: 0.72rem;">
  Subject just gives the AI a hint (Math, Science, etc.). You can leave it on <strong>Auto</strong>.
</p>


    <div class="main-layout">
      <div class="content">
        <!-- SNAP & SOLVE (always visible main input) -->
        <section id="snap">
          <div class="card">
            <h2>Snap & Solve</h2>
            <p class="desc">
              Take a photo or screenshot of homework ‚Üí text ‚Üí AI explanation.
            </p>

            <label for="snapInput">Homework image</label>

            <!-- Hidden file inputs: gallery + camera -->
            <input
              type="file"
              id="snapInputGallery"
              accept="image/*"
              style="display:none;"
            />
            <input
              type="file"
              id="snapInputCamera"
              accept="image/*"
              capture="environment"
              style="display:none;"
            />

            <div class="btn-row">
              <!-- Open camera / gallery -->
              <button id="snapCameraBtn" type="button">
                <span class="material-symbols-outlined">photo_camera</span>
                <span>Take Photo</span>
              </button>

              <button id="snapUploadBtn" class="secondary" type="button">
                <span class="material-symbols-outlined">image</span>
                <span>Upload Image</span>
              </button>

              <button id="snapOCRBtn" type="button">
                <span class="material-symbols-outlined">scan</span>
                <span>Run OCR</span>
              </button>

              <button class="secondary" id="snapClearBtn" type="button">
                <span class="material-symbols-outlined">delete</span>
                <span>Clear</span>
              </button>
            </div>

            <!-- Preview -->
            <img
              id="snapPreview"
              alt="Homework preview"
              style="
                margin-top: 8px;
                max-width: 100%;
                border-radius: 12px;
                display: none;
              "
            />

            <label for="snapText">Recognized text (main input for all tools ‚Äî you can also type here)</label>
            <textarea
              id="snapText"
              placeholder="OCR text will appear here..."
            ></textarea>

            <!-- NEW: custom subject / folder name for saving work -->
            <div class="hint-row" style="margin-top: 4px;">
              <span class="desc" style="margin: 0; font-size: 0.75rem;">
                Save this work under:
              </span>
              <input
                id="saveSubjectInput"
                type="text"
                value="general"
                placeholder="e.g. Algebra test 2"
                style="
                  margin-left: 8px;
                  font-size: 0.9rem;
                  padding: 8px 10px;
                  border-radius: 999px;
                  border: 1px solid rgba(148, 163, 184, 0.7);
                  flex: 0 0 auto;
                  min-width: 110px;
                "
              />
            </div>

            <div class="hint-row" style="margin-top: 16px;">
  <span class="desc" style="margin: 0; font-size: 0.75rem;">
    What do you want to do with this text?
  </span>
</div>

<div class="hint-row" style="margin-top: 4px;">
  <button id="snapActionSolveBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined" style="font-size: 16px;">
      photo_camera
    </span>
    <span>Solve / Explain here</span>
  </button>

  <button id="mathSolveBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined">calculate</span>
    <span>Math Solver</span>
  </button>

  <button id="studyGuideBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined">menu_book</span>
    <span>Study Guide</span>
  </button>

  <button id="essayBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined">draw</span>
    <span>Essay Helper</span>
  </button>

  <button id="cardsBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined">style</span>
    <span>Flashcards</span>
  </button>

  <button id="quizBtn" class="pill-button" type="button">
    <span class="material-symbols-outlined">quiz</span>
    <span>Quiz Maker</span>
  </button>
</div>




           

           
          </div>
        </section>
<!-- SOLVE RESULT (new tool section) -->
<section id="solve" class="tab-content">
  <div class="card">
    <h2>Solve</h2>
    <p class="desc">
      Results from solving the text in the Snap area.
    </p>
<div class="hint-row">
  <button
    class="pill-button"
    type="button"
    data-action="simplify"
    data-target="snapResult"
  >
    <span
      class="material-symbols-outlined"
      style="font-size: 16px;"
    >lightbulb</span>
    Explain simpler
  </button>
  <button
    class="pill-button"
    type="button"
    data-action="hint"
    data-target="snapResult"
  >
    <span
      class="material-symbols-outlined"
      style="font-size: 16px;"
    >tips_and_updates</span>
    Give me a hint
  </button>
</div>

    <pre id="snapResult"></pre>
  </div>
</section>

        <!-- MATH SOLVER -->
        <section id="math" class="tab-content">
          <div class="card">
            <h2>Math Solver</h2>
            <p class="desc">
              Type or paste a math question ‚Üí step-by-step solution.
            </p>

            <label for="snapText">Math problem (uses the main text box above)</label>
            <textarea
              id="mathInput"
              placeholder="Example: Solve 3x + 7 = 22"
              style="display:none;"
            ></textarea>

            <!-- Action button removed here; only Clear remains -->
            <div class="btn-row">
              <button class="secondary" id="mathClearBtn" type="button">
                <span class="material-symbols-outlined">delete</span>
                <span>Clear</span>
              </button>
            </div>

            <div class="hint-row">
              <button
                class="pill-button"
                data-action="simplify"
                data-target="mathResult"
              >
                <span
                  class="material-symbols-outlined"
                  style="font-size: 16px;"
                >lightbulb</span>
                Explain simpler
              </button>
            </div>

            <pre id="mathResult"></pre>
          </div>
        </section>

        <!-- STUDY GUIDE -->
        <section id="study" class="tab-content">
          <div class="card">
            <h2>Study Guide</h2>
            <p class="desc">
              Turn messy notes or textbook text into a clean study guide.
            </p>

            <label for="snapText">Notes or textbook text (uses the main text box above)</label>
            <textarea
              id="studyInput"
              placeholder="Paste your notes or textbook text here..."
              style="display:none;"
            ></textarea>

            <!-- Action button removed here; only Clear remains -->
            <div class="btn-row">
              <button class="secondary" id="studyClearBtn" type="button">
                <span class="material-symbols-outlined">delete</span>
                <span>Clear</span>
              </button>
            </div>

            <div class="hint-row">
              <button
                class="pill-button"
                data-action="simplify"
                data-target="studyResult"
              >
                <span
                  class="material-symbols-outlined"
                  style="font-size: 16px;"
                >lightbulb</span>
                Explain simpler
              </button>
            </div>

            <pre id="studyResult"></pre>
          </div>
        </section>

        <!-- ESSAY HELPER -->
        <section id="essay" class="tab-content">
          <div class="card">
            <h2>Essay Helper</h2>
            <p class="desc">
              Fix grammar, improve structure, or generate a draft from a prompt.
            </p>

            <label for="snapText">Essay text or assignment prompt (uses the main text box above)</label>
            <textarea
              id="essayInput"
              placeholder="Paste your essay or describe what you need to write..."
              style="display:none;"
            ></textarea>

            <!-- Action button removed here; only Clear remains -->
            <div class="btn-row">
              <button class="secondary" id="essayClearBtn" type="button">
                <span class="material-symbols-outlined">delete</span>
                <span>Clear</span>
              </button>
            </div>

            <div class="hint-row">
              <button
                class="pill-button"
                data-action="simplify"
                data-target="essayResult"
              >
                <span
                  class="material-symbols-outlined"
                  style="font-size: 16px;"
                >lightbulb</span>
                Simpler version
              </button>
            </div>

            <pre id="essayResult"></pre>
          </div>
        </section>

<section id="flashcards" class="tab-content">
  <div class="card">
    <h2>Flashcards</h2>
    <p class="desc">
      Paste content ‚Üí get term/question ‚Üí answer flashcards.
    </p>

    <label for="snapText">Source text for flashcards (uses the main text box above)</label>
    <textarea
      id="cardsInput"
      placeholder="Paste notes, vocabulary lists, or textbook text..."
      style="display:none;"
    ></textarea>

    <!-- Action button removed here; only Clear remains -->
    <div class="btn-row">
      <button class="secondary" id="cardsClearBtn" type="button">
        <span class="material-symbols-outlined">delete</span>
        <span>Clear</span>
      </button>
    </div>

    <!-- Raw AI output (for debug / copy) -->
    <pre id="cardsResult"></pre>

    <!-- New interactive flashcard viewer -->
    <div id="cardsViewer" style="display: none; margin-top: 10px;">
      <div id="cardsStats" class="desc">
        <!-- e.g. Card 1 of 10 ‚Ä¢ Got it: 3 ‚Ä¢ Need work: 2 -->
      </div>

      <div id="cardsCard" class="flashcard">
        <div id="cardsFront" class="flashcard-side">
          Front
        </div>
        <div id="cardsBack" class="flashcard-side" style="display: none;">
          Back
        </div>
      </div>

      <div class="btn-row" style="margin-top: 8px;">
        <button class="secondary" id="cardsNeedWorkBtn" type="button">
          <span class="material-symbols-outlined">priority_high</span>
          <span>Need work</span>
        </button>
		
        <button class="secondary" id="cardsGotItBtn" type="button">
          <span class="material-symbols-outlined">check_circle</span>
          <span>Got it</span>
        </button>
        
		<button id="cardsFlipBtn" type="button">
          <span class="material-symbols-outlined">sync</span>
          <span>Flip</span>
        </button>
      </div>
    </div>
  </div>
</section>


        <!-- QUIZ MAKER -->
        <section id="quiz" class="tab-content">
          <div class="card">
            <h2>Quiz Maker</h2>
            <p class="desc">
              Turn notes into multiple-choice and short-answer questions.
            </p>

            <label for="snapText">Material to quiz on (uses the main text box above)</label>
            <textarea
              id="quizInput"
              placeholder="Paste notes or textbook section..."
              style="display:none;"
            ></textarea>

            <!-- Action button removed here; only Clear remains -->
            <div class="btn-row">
              <button class="secondary" id="quizClearBtn" type="button">
                <span class="material-symbols-outlined">delete</span>
                <span>Clear</span>
              </button>
            </div>

            <pre id="quizResult"></pre>
          </div>
        </section>

        <!-- NOTEBOOK -->


        <section id="notebook" class="tab-content">

          <div class="card">
		          <section id="notebook" class="tab-content">
			

            <h2>Notebook</h2>
            <p class="desc">
              Recent saved results from Snap, Math, Study, Essay, etc.
            </p>
			
			<div class="hint-row" id="notebookFilterRow">
  <button class="pill-button notebook-filter active" data-filter="all">
    <span class="material-symbols-outlined" style="font-size: 16px;">filter_alt</span>
    <span>All</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Snap">
    <span class="material-symbols-outlined" style="font-size: 16px;">photo_camera</span>
    <span>Solve</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Math">
    <span class="material-symbols-outlined" style="font-size: 16px;">calculate</span>
    <span>Math</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Study">
    <span class="material-symbols-outlined" style="font-size: 16px;">menu_book</span>
    <span>Study</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Essay">
    <span class="material-symbols-outlined" style="font-size: 16px;">draw</span>
    <span>Essay</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Quiz">
    <span class="material-symbols-outlined" style="font-size: 16px;">quiz</span>
    <span>Quiz</span>
  </button>

  <button class="pill-button notebook-filter" data-filter="Cards">
    <span class="material-symbols-outlined" style="font-size: 16px;">style</span>
    <span>Flashcards</span>
  </button>
</div>
 <div class="btn-row" style="margin-bottom: 8px;">
      <button class="secondary" id="clearNotebookBtn" type="button">
        <span class="material-symbols-outlined">delete_forever</span>
        <span>Clear notebook</span>
      </button>
      <!-- NEW: undo button -->
      <button class="secondary" id="undoNotebookBtn" type="button">
        <span class="material-symbols-outlined">undo</span>
        <span>Undo</span>
      </button>
    </div>

            <!-- NEW: subjects manager / chips -->
            <div id="notebookSubjects" class="hint-row" style="margin-bottom: 8px;"></div>

            <div id="notebookList"></div>
          </div>
        </section>

        <div class="hint-footer" id="hintFooter">
  AI is for learning, not cheating. Always check your work.
</div>

      </div>

      <!-- RIGHT SIDE DRAWER / SIDEBAR -->
      <aside class="side-drawer" id="sideDrawer">
        <div class="side-drawer-inner">
          <div class="side-drawer-header">TOOLS</div>
          <nav class="side-nav">
            <button class="nav-btn active" data-target="solve" type="button">
  <span class="material-symbols-outlined">photo_camera</span>
  <span class="label">Solve</span>
</button>

            <button class="nav-btn" data-target="math" type="button">
              <span class="material-symbols-outlined">calculate</span>
              <span class="label">Math Solver</span>
            </button>
            <button class="nav-btn" data-target="study" type="button">
              <span class="material-symbols-outlined">menu_book</span>
              <span class="label">Study Guide</span>
            </button>
            <button class="nav-btn" data-target="essay" type="button">
              <span class="material-symbols-outlined">draw</span>
              <span class="label">Essay Helper</span>
            </button>
            <button class="nav-btn" data-target="flashcards" type="button">
              <span class="material-symbols-outlined">style</span>
              <span class="label">Flashcards</span>
            </button>
            <button class="nav-btn" data-target="quiz" type="button">
              <span class="material-symbols-outlined">quiz</span>
              <span class="label">Quiz Maker</span>
            </button>
            <button class="nav-btn" data-target="notebook" type="button">
              <span class="material-symbols-outlined">book_2</span>
              <span class="label">Notebook</span>
            </button>
          </nav>
        </div>
      </aside>
    </div>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>

<!-- BLOCK 1: Theme toggle, cheat/learn mode, drawer/sidebar, subject/model helpers -->
<script>
// ---------- THEME TOGGLE ----------
const themeToggle = document.getElementById("themeToggle");
const themeLabel = document.getElementById("themeLabel");
const iconSun = document.getElementById("iconSun");
const iconMoon = document.getElementById("iconMoon");

// NEW: keep browser/status bar color in sync
function applyThemeColor(theme) {
  const meta = document.querySelector('meta[name="theme-color"]');
  if (!meta) return;
  const isDark = theme === "dark";
  // dark uses your dark surface, light uses your light header/bg
  meta.setAttribute("content", isDark ? "#020617" : "#f9fafb");
}

function setTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("studyai-theme", theme);

  const dark = theme === "dark";
  themeLabel.textContent = dark ? "Dark" : "Light";
  iconSun.style.display = dark ? "block" : "none";
  iconMoon.style.display = dark ? "none" : "block";

  // NEW: sync meta tag
  applyThemeColor(theme);
}

// use whatever the <html> tag currently has as the initial theme
const initialTheme =
  document.documentElement.getAttribute("data-theme") || "dark";
setTheme(initialTheme);

themeToggle.addEventListener("click", () => {
  const current =
    document.documentElement.getAttribute("data-theme") || "dark";
  setTheme(current === "dark" ? "light" : "dark");
});




  // ---------- DRAWER / SIDEBAR ----------
  const drawerToggle = document.getElementById("drawerToggle");
  const sideDrawer = document.getElementById("sideDrawer");
  const drawerBackdrop = document.getElementById("drawerBackdrop");

  function isDesktop() {
    return window.innerWidth >= 800;
  }

  function openDrawer() {
    if (isDesktop()) return; // always visible on desktop
    sideDrawer.classList.add("open");
    drawerBackdrop.classList.add("show");
  }

  function closeDrawer() {
    if (isDesktop()) return;
    sideDrawer.classList.remove("open");
    drawerBackdrop.classList.remove("show");
  }

  if (drawerToggle) {
    drawerToggle.addEventListener("click", () => {
      if (sideDrawer.classList.contains("open")) {
        closeDrawer();
      } else {
        openDrawer();
      }
    });
  }

  drawerBackdrop.addEventListener("click", closeDrawer);

  window.addEventListener("resize", () => {
    if (isDesktop()) {
      sideDrawer.classList.add("open");
      drawerBackdrop.classList.remove("show");
    } else {
      sideDrawer.classList.remove("open");
    }
  });

  if (isDesktop()) {
    sideDrawer.classList.add("open");
  }

  // ---------- SUBJECT / MODEL HELPERS ----------
  const subjectSelect = document.getElementById("subjectSelect");
  const modelSelect = document.getElementById("modelSelect");

  function getSubject() {
    return subjectSelect?.value || "general";
  }

  function getModelChoice() {
    return modelSelect?.value || "smart";
  }
</script>

<script>
  // ---------- CHEAT MODE TOGGLE ----------
  const modeChip = document.getElementById("modeChip");
  window.__cheatMode = false; // false = learn mode ON, true = hidden cheat mode

  // If the chip isn't on the page for some reason, bail out safely
  if (!modeChip) {
    console.warn("modeChip element not found; cheat/learn toggle not initialized.");
  } else {
    const modeLabel = modeChip.querySelector(".mode-label");
    const chipDot = modeChip.querySelector(".chip-dot");

    function updateModeChip() {
      const isLearnOn = !window.__cheatMode;

      // Text: never mention "cheat mode" in the UI
      if (modeLabel) {
        modeLabel.textContent = isLearnOn ? "Learn mode ON" : "Learn mode OFF";
      }

      // Visually act like a green/red toggle switch
      if (chipDot) {
        chipDot.style.backgroundColor = isLearnOn ? "#22c55e" : "#ef4444"; // green / red dot
      }

      modeChip.style.borderColor = isLearnOn
        ? "rgba(34,197,94,0.6)"          // green border
        : "rgba(239,68,68,0.6)";         // red border

      modeChip.style.backgroundColor = isLearnOn
        ? "rgba(34,197,94,0.12)"         // light green bg
        : "rgba(239,68,68,0.12)";        // light red bg

      modeChip.setAttribute("data-state", isLearnOn ? "on" : "off");
    }

    modeChip.addEventListener("click", () => {
      // Flip between learn (false) and hidden cheat (true)
      window.__cheatMode = !window.__cheatMode;
      updateModeChip();
    });

    // Initial state: Learn mode ON (green)
    updateModeChip();
  }
</script>



<!-- BLOCK 2: Notebook load/save/render, filters, add item -->
<script>
  // ---------- NOTEBOOK ----------
  const notebookKey = "studyai-notebook";
  const notebookListEl = document.getElementById("notebookList");
  const notebookFilterButtons = document.querySelectorAll(".notebook-filter");
  const notebookSubjectsEl = document.getElementById("notebookSubjects");
  let notebookFilter = "all";
  let notebookSubjectFilter = "all";
  let notebookLastSnapshot = null; // for undo

  function loadNotebook() {
    try {
      return JSON.parse(localStorage.getItem(notebookKey) || "[]");
    } catch {
      return [];
    }
  }

  function saveNotebook(items) {
    localStorage.setItem(notebookKey, JSON.stringify(items.slice(-200))); // keep last 200
  }

  // NEW: subject name used when saving notebook items
  function getSaveSubject() {
    const input = document.getElementById("saveSubjectInput");
    if (!input) return "general";
    const value = (input.value || "").trim();
    return value || "general";
  }

  // NEW: render subjects list / chips
  function renderNotebookSubjects(allItems) {
    if (!notebookSubjectsEl) return;

    const subjects = Array.from(
      new Set(
        allItems.map((i) => {
          const s = (i.subject || "general").trim();
          return s || "general";
        })
      )
    ).sort((a, b) => a.localeCompare(b));

    notebookSubjectsEl.innerHTML = "";

    if (!subjects.length) {
      return;
    }

    subjects.forEach((subj) => {
      const row = document.createElement("div");
      row.className = "notebook-subject-row";
      row.style.position = "relative";
      row.style.display = "inline-flex";
      row.style.alignItems = "center";
      row.style.gap = "4px";

      const subjBtn = document.createElement("button");
      subjBtn.type = "button";
      subjBtn.className = "pill-button notebook-subject-btn";
      if (notebookSubjectFilter === subj) {
        subjBtn.classList.add("active");
      }
      subjBtn.dataset.subject = subj;
      subjBtn.textContent = subj;

      // small "menu" button to toggle dropdown
      const menuBtn = document.createElement("button");
      menuBtn.type = "button";
      menuBtn.className = "pill-button notebook-subject-menu";
      menuBtn.dataset.subject = subj;
      menuBtn.textContent = "‚ãØ";

      // dropdown container (hidden by default)
      const dropdown = document.createElement("div");
      dropdown.className = "notebook-subject-dropdown";
      dropdown.style.display = "none";
      dropdown.style.position = "absolute";
      dropdown.style.right = "0";
      dropdown.style.top = "110%";
      dropdown.style.background = "#fff";
      dropdown.style.border = "1px solid var(--outline)";
      dropdown.style.borderRadius = "0px";
      dropdown.style.padding = "1em";
      dropdown.style.zIndex = "20";
      dropdown.style.whiteSpace = "nowrap";

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "pill-button notebook-subject-edit";
      editBtn.dataset.subject = subj;
      editBtn.textContent = "Rename subject";

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "pill-button notebook-subject-delete";
      delBtn.dataset.subject = subj;
      delBtn.textContent = "Delete subject & notes";

      dropdown.appendChild(editBtn);
      dropdown.appendChild(delBtn);

      // üîπ direct handler for this menu button
      menuBtn.addEventListener("click", (ev) => {
  ev.stopPropagation();
  const isShowing = dropdown.style.display === "flex";
  dropdown.style.display = isShowing ? "none" : "flex";
});


      row.appendChild(subjBtn);
      row.appendChild(menuBtn);
      row.appendChild(dropdown);

      notebookSubjectsEl.appendChild(row);
    });
  }

  function renderNotebook() {
    if (!notebookListEl) return;

    const allItems = loadNotebook();
    notebookListEl.innerHTML = "";

    // always render subjects list from full set
    renderNotebookSubjects(allItems);

    if (!allItems.length) {
      notebookListEl.innerHTML =
        '<p class="desc">Nothing saved yet. Solve something and it will appear here.</p>';
      return;
    }

    const byType =
      notebookFilter === "all"
        ? allItems
        : allItems.filter((i) => i.type === notebookFilter);

    const items =
      notebookSubjectFilter === "all"
        ? byType
        : byType.filter(
            (i) =>
              (i.subject || "general").trim() === notebookSubjectFilter
          );

    if (!items.length) {
      notebookListEl.innerHTML =
        '<p class="desc">No items for this filter yet.</p>';
      return;
    }

    const labelMap = {
      Snap: "Solve",
      Math: "Math Solver",
      Study: "Study Guide",
      Essay: "Essay Helper",
      Quiz: "Quiz Maker",
      Cards: "Flashcards",
      Flashcards: "Flashcards",
      Simplified: "Simplified answer",
      Hint: "Hint",
    };

    items
      .slice()
      .reverse()
      .forEach((item) => {
        const wrapper = document.createElement("div");
        wrapper.className = "notebook-item";

        const header = document.createElement("div");
        header.className = "notebook-item-header";

        const meta = document.createElement("div");
        meta.className = "notebook-meta";
        const timeStr = new Date(item.time).toLocaleString();
        meta.textContent = `${item.type} ‚Ä¢ ${timeStr} ‚Ä¢ ${
          item.subject || "general"
        } ‚Ä¢ ${item.model || "smart"} ‚Ä¢ ${item.mode || "learn"}`;

        header.appendChild(meta);
        wrapper.appendChild(header);

        const body = document.createElement("div");
        body.textContent = item.text;
        wrapper.appendChild(body);

        // footer with "Open in ..." + Edit + Delete
        const footer = document.createElement("div");
        footer.className = "notebook-item-footer";

        const openBtn = document.createElement("button");
        openBtn.className = "pill-button notebook-open-btn";
        openBtn.type = "button";
        openBtn.dataset.id = item.id;

        const displayType =
          labelMap[item.type] || item.type || "tool";
        openBtn.textContent = "Open in " + displayType;

        const editBtn = document.createElement("button");
        editBtn.className = "pill-button notebook-item-edit";
        editBtn.type = "button";
        editBtn.dataset.id = item.id;
        editBtn.textContent = "Edit";

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "pill-button notebook-item-delete";
        deleteBtn.type = "button";
        deleteBtn.dataset.id = item.id;
        deleteBtn.textContent = "Delete";

        footer.appendChild(openBtn);
        footer.appendChild(editBtn);
        footer.appendChild(deleteBtn);
        wrapper.appendChild(footer);

        notebookListEl.appendChild(wrapper);
      });
  }

  // open a saved notebook item back in its tool
  function openNotebookItemById(itemId) {
    const items = loadNotebook();
    const item = items.find((i) => i.id === itemId);
    if (!item) return;

    const text = item.text || "";

    function safeRender(elementId) {
      const el = document.getElementById(elementId);
      if (!el) return;
      if (typeof renderAnswer === "function") {
        renderAnswer(el, text);
      } else {
        el.textContent = text;
      }
    }

    switch (item.type) {
      case "Snap":
        if (typeof activateTab === "function") {
          if (document.getElementById("solve")) {
            activateTab("solve");
          } else {
            activateTab("snap");
          }
        }
        safeRender("snapResult");
        break;

      case "Math":
        if (typeof activateTab === "function") activateTab("math");
        safeRender("mathResult");
        break;

      case "Study":
        if (typeof activateTab === "function") activateTab("study");
        safeRender("studyResult");
        break;

      case "Essay":
        if (typeof activateTab === "function") activateTab("essay");
        safeRender("essayResult");
        break;

      case "Quiz":
        if (typeof activateTab === "function") activateTab("quiz");
        safeRender("quizResult");
        break;

      case "Cards":
      case "Flashcards":
        if (typeof activateTab === "function") activateTab("flashcards");

        // put raw text back into cardsResult
        const cardsResultEl = document.getElementById("cardsResult");
        if (cardsResultEl) {
          cardsResultEl.textContent = text;
        }

        // rebuild interactive flashcards if helpers exist
        if (typeof parseFlashcardsFromText === "function") {
          try {
            const parsed = parseFlashcardsFromText(text);
            if (parsed && parsed.length) {
              if (typeof saveFlashcards === "function") {
                saveFlashcards(parsed);
              }
              if (typeof window !== "undefined") {
                window.flashcards = parsed;
                window.currentCardIndex = 0;
              }
              if (typeof renderCurrentCard === "function") {
                renderCurrentCard();
              }
            }
          } catch (e) {
            console.error("Error rebuilding flashcards from notebook:", e);
          }
        }
        break;

      case "Simplified":
      case "Hint":
      default:
        // fallback: show in Solve/Snap
        if (typeof activateTab === "function") {
          if (document.getElementById("solve")) {
            activateTab("solve");
          } else {
            activateTab("snap");
          }
        }
        safeRender("snapResult");
        break;
    }
  }

  // click handler for "Open in ...", item Edit, item Delete (event delegation)
  if (notebookListEl) {
    notebookListEl.addEventListener("click", (e) => {
      const openBtn = e.target.closest(".notebook-open-btn");
      if (openBtn) {
        const id = openBtn.dataset.id;
        if (!id) return;
        openNotebookItemById(id);
        return;
      }

      const editBtn = e.target.closest(".notebook-item-edit");
      if (editBtn) {
        const id = editBtn.dataset.id;
        if (!id) return;
        const items = loadNotebook();
        const idx = items.findIndex((i) => i.id === id);
        if (idx === -1) return;

        const oldText = items[idx].text || "";
        const newText = prompt("Edit this saved item:", oldText);
        if (newText === null) return;
        const trimmed = newText.trim();
        if (!trimmed || trimmed === oldText) return;

        const ok = confirm("Save changes to this item?");
        if (!ok) return;

        notebookLastSnapshot = items.slice();
        items[idx] = { ...items[idx], text: trimmed };
        saveNotebook(items);
        renderNotebook();
        return;
      }

      const deleteBtn = e.target.closest(".notebook-item-delete");
      if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        if (!id) return;
        const items = loadNotebook();
        const idx = items.findIndex((i) => i.id === id);
        if (idx === -1) return;

        const ok = confirm("Delete this saved item? You can undo once.");
        if (!ok) return;

        notebookLastSnapshot = items.slice();
        items.splice(idx, 1);
        saveNotebook(items);
        renderNotebook();
      }
    });
  }

  // NEW: subject chips (filter / edit / delete) using delegation (menu handled directly)
  if (notebookSubjectsEl) {
    notebookSubjectsEl.addEventListener("click", (e) => {
      const subjectBtn = e.target.closest(".notebook-subject-btn");
      if (subjectBtn) {
        const subj = subjectBtn.dataset.subject;
        if (!subj) return;
        notebookSubjectFilter =
          notebookSubjectFilter === subj ? "all" : subj;
        renderNotebook();
        return;
      }

      const editBtn = e.target.closest(".notebook-subject-edit");
      if (editBtn) {
        const oldSubj = editBtn.dataset.subject;
        if (!oldSubj) return;

        const newNameRaw = prompt("Rename subject:", oldSubj);
        if (newNameRaw === null) return;
        const newName = newNameRaw.trim();
        if (!newName || newName === oldSubj) return;

        const ok = confirm(`Rename subject "${oldSubj}" to "${newName}"?`);
        if (!ok) return;

        const items = loadNotebook();
        notebookLastSnapshot = items.slice();

        const updated = items.map((it) => {
          const s = (it.subject || "general").trim();
          if (s === oldSubj) {
            return { ...it, subject: newName };
          }
          return it;
        });

        if (notebookSubjectFilter === oldSubj) {
          notebookSubjectFilter = newName;
        }

        saveNotebook(updated);
        renderNotebook();
        return;
      }

      const delBtn = e.target.closest(".notebook-subject-delete");
      if (delBtn) {
        const subj = delBtn.dataset.subject;
        if (!subj) return;

        const ok = confirm(
          `Delete subject "${subj}" and all its saved work? You can undo once.`
        );
        if (!ok) return;

        const items = loadNotebook();
        notebookLastSnapshot = items.slice();
        const remaining = items.filter(
          (it) => (it.subject || "general").trim() !== subj
        );

        if (notebookSubjectFilter === subj) {
          notebookSubjectFilter = "all";
        }

        saveNotebook(remaining);
        renderNotebook();
      }
    });
  }

  // Notebook filters (All, Snap, Math, Study, Essay, Quiz...)
  notebookFilterButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      notebookFilterButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      notebookFilter = btn.dataset.filter || "all";
      renderNotebook();
    });
  });

  // Add an item to notebook
  function addNotebookItem(type, text) {
    if (!text || !text.trim()) return;
    const items = loadNotebook();
    notebookLastSnapshot = items.slice(); // allow undo of this insert
    items.push({
      id: Date.now() + Math.random().toString(16).slice(2),
      type, // "Snap", "Math", "Study", etc.
      text: text.trim(),
      time: Date.now(),
      subject: getSaveSubject(),
      model: getModelChoice(),
      mode: window.__cheatMode ? "cheat" : "learn",
      pinned: false,
    });
    saveNotebook(items);
    renderNotebook();
  }

  // NEW: clear notebook + undo
  const clearNotebookBtn = document.getElementById("clearNotebookBtn");
  if (clearNotebookBtn) {
    clearNotebookBtn.addEventListener("click", () => {
      const items = loadNotebook();
      if (!items.length) {
        alert("Notebook is already empty.");
        return;
      }
      const ok = confirm(
        "Clear all saved notebook items? You can undo this once."
      );
      if (!ok) return;
      notebookLastSnapshot = items.slice();
      saveNotebook([]);

      renderNotebook();
    });
  }

  const undoNotebookBtn = document.getElementById("undoNotebookBtn");
  if (undoNotebookBtn) {
    undoNotebookBtn.addEventListener("click", () => {
      if (!notebookLastSnapshot) {
        alert("Nothing to undo yet.");
        return;
      }
      saveNotebook(notebookLastSnapshot);
      notebookLastSnapshot = null;
      renderNotebook();
    });
  }

  // Initial render
  renderNotebook();
</script>


<!-- BLOCK 3: Answer sanitizing, AI backend call, and all task helpers -->
<script>
function sanitizeAnswerText(raw) {
  if (!raw) return "";
  let text = String(raw);

  text = text.replace(/^\s*#{1,6}\s+.*$/gm, "");
  text = text.replace(/^\s*[-*_]{3,}\s*$/gm, "");
  text = text.replace(/---/g, "");
  text = text.replace(/```/g, "");

  text = text.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, "$1/$2");
  text = text.replace(/\\sqrt\{([^}]+)\}/g, "‚àö($1)");
  text = text.replace(/‚àö\(([^()]+)\)/g, "‚àö$1");
  text = text.replace(/\\boxed\{([^}]+)\}/g, "$1");

  text = text.replace(/\\\(|\\\)/g, "");
  text = text.replace(/\\\[|\\\]/g, "");
  text = text.replace(/\$\$/g, "");
  text = text.replace(/\$(.*?)\$/g, "$1");

  text = text.replace(/\\times/g, "√ó");
  text = text.replace(/\\cdot/g, "¬∑");

  text = text.replace(/^\s*-\s+(?!\d)/gm, "");
  text = text.replace(/^\s*\*\s+(?!\d)/gm, "");

  text = text.replace(/^Lets solve.*$/gmi, "");

  text = text.replace(/[\\`#*_$>]/g, "");
  text = text.replace(/\r\n/g, "\n");
  text = text.replace(/\n{3,}/g, "\n\n");
  // If we have a line that ends with "Final answer:" and nothing after it,
  // fill it with the last number we see in the text.
  const finalLineMatch = text.match(/Final answer:\s*$/m);
  if (finalLineMatch) {
    const numbers = text.match(/-?\d+(\.\d+)?/g);
    if (numbers && numbers.length > 0) {
      const lastNum = numbers[numbers.length - 1];
      text = text.replace(/Final answer:\s*$/m, "Final answer: " + lastNum);
    }
  }

  return text.trim();
}
function renderAnswer(preEl, text) {
  if (!preEl) return;

  const escaped = String(text || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  const lines = escaped.split("\n");

  const htmlLines = lines.map((line) => {
    const trimmed = line.trim();

    // Final answer: ...
    const finalMatch = line.match(/^(Final answer:\s*)(.*)$/i);
    if (finalMatch) {
      const label = finalMatch[1];
      const value = finalMatch[2] || "";
      return `<span class="answer-label">${label}</span><span class="answer-value"> ${value}</span>`;
    }

    // Step 1:, Step 2, etc.
    if (/^Step\s+\d+/i.test(trimmed)) {
      return `<span class="step-line">${line}</span>`;
    }

    // Section headings like "Summary:", "Answer Key:", etc.
    if (/^(Summary|Answer Key|Multiple Choice|Short Answer|True\/False)\s*:/i.test(trimmed)) {
      return `<span class="section-heading">${line}</span>`;
    }

    // "Hint:"
    if (/^Hint:\s*$/i.test(trimmed)) {
      return `<span class="hint-label">Hint</span>`;
    }

    return line;
  });

  preEl.innerHTML = htmlLines.join("\n");
}



  // ---------- AI ENGINE (BACKEND HOOK POINT) ----------
  async function callAI({ prompt, task }) {
    const modelChoice = getModelChoice();
    const subject = getSubject();
    const mode = window.__cheatMode ? "cheat" : "learn";

    try {
      const res = await fetch("/api/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt:
            `Mode: ${mode}\n` +
            `Subject: ${subject}\n` +
            `Tool: ${task}\n\n` +
            prompt,
          task,
          model: modelChoice,
        }),
      });

      if (!res.ok) {
        throw new Error("Network error (" + res.status + ")");
      }

      const data = await res.json();
      if (data.error) throw new Error(data.error);

      return data.text || "[Empty response]";
    } catch (err) {
      console.error(err);
      return "‚ö†Ô∏è Error talking to AI:\n" + err.message;
    }
  }

  // ---------- TASK HELPERS ----------
  async function runMathSolver(text) {
    const cheat = window.__cheatMode;
    const prompt = cheat
      ? "Solve this math problem and give ONLY the final numeric/algebraic answer. " +
        "If there are multiple parts, label each answer clearly (a), b), c), etc.).\n\nProblem:\n" +
        text.trim()
      : "You are a step-by-step math tutor for a middle/high school student.\n" +
"Solve the problem clearly. Show each step, and END with a line exactly like:\n" +
"`Final answer: <number>`\n\n" +
"Problem:\n" +
text.trim();

    return callAI({ prompt, task: "math" });
  }

  async function runStudyGuide(text) {
    const prompt =
      "Turn the following notes or textbook text into a study guide for a student.\n" +
      "Output:\n- Bullet point main ideas\n- Key definitions\n- Short summary at the end.\n\n" +
      text.trim();
    return callAI({ prompt, task: "study_guide" });
  }

  async function runEssayHelper(text) {
    const cheat = window.__cheatMode;
    const prompt = cheat
      ? "Write a strong, polished essay based on this text or prompt. Just give the finished essay.\n\nInput:\n" +
        text.trim()
      : "You are an essay helper for a middle/high school student.\n" +
        "If the text looks like a draft, improve clarity, grammar, and structure but keep their voice.\n" +
        "If it is a prompt, generate a well-structured answer.\n\n" +
        "Input:\n" +
        text.trim();
    return callAI({ prompt, task: "essay" });
  }

  async function runFlashcards(text) {
    const prompt =
      "Create useful flashcards from this content for a student.\n" +
      "Output format strictly like:\n" +
      "Q: ...\nA: ...\n\n" +
      "Use many short cards.\n\n" +
      "Content:\n" +
      text.trim();

    return callAI({ prompt, task: "flashcards" });
  }

  async function runQuiz(text) {
    const prompt =
      "Create a short quiz (5-10 questions) for a student based on this text.\n" +
      "Include a mix of multiple choice, short answer, and true/false.\n" +
      "Format clearly so it's easy to read:\n1) Question\nA)\nB)\n...\n\nThen provide an Answer Key at the end.\n\nText:\n" +
      text.trim();
    return callAI({ prompt, task: "quiz" });
  }

  async function runSimplify(text) {
    const prompt =
      "Explain the following answer in much simpler language for a middle or high school student. Keep key ideas, but shorten and simplify:\n\n" +
      text.trim();
    return callAI({ prompt, task: "simplify" });
  }

  async function runHint(question, existingAnswer) {
    const prompt =
      "Give a helpful hint (not the full solution) for this problem for a student.\n" +
      "Keep it short and focused.\n\nProblem:\n" +
      question.trim() +
      "\n\nExisting answer (if any):\n" +
      (existingAnswer || "");
    return callAI({ prompt, task: "hint" });
  }

  async function runSnapSolve(text) {
    const cheat = window.__cheatMode;
    const prompt = cheat
      ? "A student scanned this homework text. Give the direct final answers as clearly as possible. " +
        "If there are multiple questions, number each answer so it matches. Minimal explanation.\n\n" +
        text.trim()
      : "A student scanned this homework text. Solve or explain it step-by-step in a clear way.\n\n" +
        text.trim();
    return callAI({ prompt, task: "snap" });
  }
</script>

<!-- BLOCK 4: Image resize helper and OCR call to backend -->
<script>
  // Helper: resize image before sending to backend (faster on phones)
  function resizeImageToDataUrl(file, maxWidth = 1200, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(1, maxWidth / img.width);
          const w = img.width * scale;
          const h = img.height * scale;

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          try {
            const dataUrl = canvas.toDataURL("image/jpeg", quality);
            resolve(dataUrl);
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- REAL OCR VIA AI BACKEND ----------
  async function runFakeOCR(file) {
    // Resize the image first to keep things fast on phones
    const imageData = await resizeImageToDataUrl(file, 1200, 0.8);

    const subject = getSubject();
    const modelChoice = getModelChoice();
    const mode = window.__cheatMode ? "cheat" : "learn";

    const body = {
      prompt:
        `Mode: ${mode}\n` +
        `Subject: ${subject}\n` +
        `Tool: ocr\n\n` +
        "Extract the text from this homework image and return plain text only.",
      task: "ocr",
      model: modelChoice,
      imageData: imageData,
    };

    try {
      const res = await fetch("/api/ocr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("Network error (" + res.status + ")");
      }

      const data = await res.json();
      if (data.error) throw new Error(data.error);

      return data.text || "";
    } catch (err) {
      console.error("OCR error:", err);
      return "‚ö†Ô∏è Error during OCR: " + err.message;
    }
  }
</script>

<!-- BLOCK 5: Tabs / sidenav navigation -->
<script>
  // ---------- TABS (SIDENAV) ----------
  const navBtns = document.querySelectorAll(".nav-btn");
  const tabs = document.querySelectorAll(".tab-content");
  const LAST_TAB_KEY = "studyai-last-tab";

  function activateTab(targetId) {
    let found = false;

    navBtns.forEach((b) => {
      const isTarget = b.dataset.target === targetId;
      if (isTarget) found = true;
      b.classList.toggle("active", isTarget);
    });

    tabs.forEach((t) => {
      t.classList.toggle("active", t.id === targetId);
    });

    if (!found && targetId !== "solve") {
    activateTab("solve");
  }
}

  navBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      localStorage.setItem(LAST_TAB_KEY, target);
      activateTab(target);
      if (!isDesktop()) {
        closeDrawer();
      }
    });
  });

  const savedTab = localStorage.getItem(LAST_TAB_KEY) || "solve";
activateTab(savedTab);

</script>

<!-- BLOCK 6: UI wiring for Snap, Math, Study, Essay -->
<script>
  // ---------- UI WIRING ----------

  // SNAP (now with camera + gallery inputs)
  const snapInputGallery = document.getElementById("snapInputGallery");
  const snapInputCamera = document.getElementById("snapInputCamera");
  const snapOCRBtn = document.getElementById("snapOCRBtn");
  const snapClearBtn = document.getElementById("snapClearBtn");
  const snapText = document.getElementById("snapText");
  const snapResult = document.getElementById("snapResult");
  const snapSolveBtn = document.getElementById("snapActionSolveBtn");

  const snapCameraBtn = document.getElementById("snapCameraBtn");
  const snapUploadBtn = document.getElementById("snapUploadBtn");
  const snapPreview = document.getElementById("snapPreview");

  // keep track of whichever file was chosen last
  let lastSnapFile = null;

  function handleSnapFile(file) {
    if (!file) {
      lastSnapFile = null;
      if (snapPreview) {
        snapPreview.src = "";
        snapPreview.style.display = "none";
      }
      return;
    }

    lastSnapFile = file;

    const reader = new FileReader();
    reader.onload = (e) => {
      if (snapPreview) {
        snapPreview.src = e.target.result;
        snapPreview.style.display = "block";
      }
    };
    reader.readAsDataURL(file);
  }

  // Open CAMERA
  if (snapCameraBtn && snapInputCamera) {
    snapCameraBtn.addEventListener("click", () => {
      snapInputCamera.click();
    });
  }

  // Open GALLERY / FILE PICKER
  if (snapUploadBtn && snapInputGallery) {
    snapUploadBtn.addEventListener("click", () => {
      snapInputGallery.click();
    });
  }

  // When user picks from camera
  if (snapInputCamera) {
    snapInputCamera.addEventListener("change", () => {
      const file = snapInputCamera.files[0];
      handleSnapFile(file);
    });
  }

  // When user picks from gallery
  if (snapInputGallery) {
    snapInputGallery.addEventListener("change", () => {
      const file = snapInputGallery.files[0];
      handleSnapFile(file);
    });
  }

  // Run OCR on whichever file we last picked ‚Äì DOES NOT affect usage counts
  snapOCRBtn.addEventListener("click", async () => {
    if (!lastSnapFile) {
      alert("Choose or take an image first.");
      return;
    }
    snapText.value = "Reading image...";
    const text = await runFakeOCR(lastSnapFile);
    snapText.value = text;
  });

  // Clear everything
  snapClearBtn.addEventListener("click", () => {
    if (snapInputCamera) snapInputCamera.value = "";
    if (snapInputGallery) snapInputGallery.value = "";
    lastSnapFile = null;
    snapText.value = "";
    snapResult.textContent = "";
    if (snapPreview) {
      snapPreview.src = "";
      snapPreview.style.display = "none";
    }
  });

  // Solve / Explain (usage counted based on snapText)
  snapSolveBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("No text to solve.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    // switch to the Solve tool section
    if (typeof activateTab === "function") {
      activateTab("solve");
    }

    snapResult.textContent = "Thinking...";
    const ans = await runSnapSolve(text);
    const clean = sanitizeAnswerText(ans);
    renderAnswer(snapResult, clean); // üëà instead of snapResult.textContent = clean;
    addNotebookItem("Snap", clean);
  });


  // MATH (usage counted based on snapText)
  const mathInput = document.getElementById("mathInput");
  const mathSolveBtn = document.getElementById("mathSolveBtn");
  const mathClearBtn = document.getElementById("mathClearBtn");
  const mathResult = document.getElementById("mathResult");

  mathSolveBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("Type or paste a math problem into the main text box first.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    mathResult.textContent = "Thinking...";
    const ans = await runMathSolver(text);
    const clean = sanitizeAnswerText(ans);
    renderAnswer(mathResult, clean);   // üëà was mathResult.textContent = clean;
    addNotebookItem("Math", clean);
  });

  mathClearBtn.addEventListener("click", () => {
    mathResult.textContent = "";
  });

  // STUDY (usage counted based on snapText)
  const studyInput = document.getElementById("studyInput");
  const studyGuideBtn = document.getElementById("studyGuideBtn");
  const studyClearBtn = document.getElementById("studyClearBtn");
  const studyResult = document.getElementById("studyResult");

  studyGuideBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("Paste some notes or text into the main text box first.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    studyResult.textContent = "Thinking...";
    const ans = await runStudyGuide(text);
    const clean = sanitizeAnswerText(ans);
    renderAnswer(studyResult, clean);   // üëà instead of studyResult.textContent = clean;
    addNotebookItem("Study", clean);
  });

  studyClearBtn.addEventListener("click", () => {
    studyResult.textContent = "";
  });

  // ESSAY (usage counted based on snapText)
  const essayInput = document.getElementById("essayInput");
  const essayBtn = document.getElementById("essayBtn");
  const essayClearBtn = document.getElementById("essayClearBtn");
  const essayResult = document.getElementById("essayResult");

  essayBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("Paste your essay or prompt into the main text box first.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    essayResult.textContent = "Thinking...";
    const ans = await runEssayHelper(text);
    const clean = sanitizeAnswerText(ans);
    renderAnswer(essayResult, clean);   // üëà
    addNotebookItem("Essay", clean);
  });

  essayClearBtn.addEventListener("click", () => {
    essayResult.textContent = "";
  });
</script>


<!-- BLOCK 7: Flashcards generation + interactive viewer -->
<script>
  // ---------- FLASHCARDS (interactive) ----------
  const cardsInput = document.getElementById("cardsInput");
  const cardsBtn = document.getElementById("cardsBtn");
  const cardsClearBtn = document.getElementById("cardsClearBtn");
  const cardsResult = document.getElementById("cardsResult");

  const cardsViewer = document.getElementById("cardsViewer");
  const cardsStats = document.getElementById("cardsStats");
  const cardsFront = document.getElementById("cardsFront");
  const cardsBack = document.getElementById("cardsBack");
  const cardsFlipBtn = document.getElementById("cardsFlipBtn");
  const cardsGotItBtn = document.getElementById("cardsGotItBtn");
  const cardsNeedWorkBtn = document.getElementById("cardsNeedWorkBtn");

  const cardsStorageKey = "studyai-flashcards";

  let flashcards = [];
  let currentCardIndex = 0;
  let showingBack = false;

  function loadFlashcardsStorage() {
    try {
      return JSON.parse(localStorage.getItem(cardsStorageKey) || "[]" );
    } catch {
      return [];
    }
  }

  function saveFlashcards(cards) {
    localStorage.setItem(cardsStorageKey, JSON.stringify(cards));
  }

  function parseFlashcardsFromText(raw) {
    const text = typeof raw === "string" ? raw : String(raw ?? "");
    const lines = text.split(/\r?\n/);
    const temp = [];
    let current = null;

    for (let line of lines) {
      const trimmed = line.trim();
      if (!trimmed) continue;

      const qMatch = trimmed.match(/^Q[\s.:,-]*?(.*)$/i);
      const aMatch = trimmed.match(/^A[\s.:,-]*?(.*)$/i);

      if (qMatch) {
        if (current && current.front && current.back) {
          temp.push(current);
        }
        current = {
          front: qMatch[1].trim(),
          back: "",
        };
      } else if (aMatch && current) {
        const piece = aMatch[1].trim();
        current.back = current.back ? current.back + "\n" + piece : piece;
      } else if (current) {
        if (!current.back) {
          current.front += "\n" + trimmed;
        } else {
          current.back += "\n" + trimmed;
        }
      }
    }

    if (current && current.front && current.back) {
      temp.push(current);
    }

    const now = Date.now();
    return temp.map((c, i) => ({
      id: now + "-" + i,
      front: c.front,
      back: c.back,
      status: "new",
      seen: 0,
      correct: 0,
      lastSeen: now,
    }));
  }

function updateCardsStats() {
  if (!flashcards.length) {
    cardsStats.textContent = "No cards yet. Create some above.";
    return;
  }
  const total = flashcards.length;
  const got = flashcards.filter((c) => c.status === "got").length;
  const need = flashcards.filter((c) => c.status === "need_work").length;
  const indexLabel = currentCardIndex + 1;

  cardsStats.textContent =
    `Card ${indexLabel} of ${total}` +
    ` ‚Ä¢ Got it ${got}` +          // ‚Üê no colon
    ` ‚Ä¢ Need work ${need}`;       // ‚Üê no colon
}



function renderCurrentCard() {
  if (!cardsViewer) return;

  if (!flashcards.length) {
    cardsViewer.style.display = "none";
    return;
  }

  if (currentCardIndex < 0 || currentCardIndex >= flashcards.length) {
    currentCardIndex = 0;
  }

  const card = flashcards[currentCardIndex];
  cardsViewer.style.display = "block";
  showingBack = false;

  cardsFront.style.display = "block";
  cardsBack.style.display = "none";

  // üîπ Strip leading "Q:" / "A:" (or any colon/semicolon right after Q/A)
  const rawFront = card.front || "[No question]";
  const rawBack  = card.back  || "[No answer]";

  const frontText = rawFront
    .replace(/^Q\s*[:;.-]*\s*/i, "")   // remove leading Q: / Q; / Q. etc
    .trim();

  const backText = rawBack
    .replace(/^A\s*[:;.-]*\s*/i, "")   // remove leading A: / A; / A. etc
    .trim();

  cardsFront.textContent = frontText || "[No question]";
  cardsBack.textContent  = backText  || "[No answer]";

  updateCardsStats();
}


  // Restore from storage
  (function initFlashcardsFromStorage() {
    const stored = loadFlashcardsStorage();
    if (stored && stored.length) {
      flashcards = stored;
      currentCardIndex = 0;
      renderCurrentCard();
    }
  })();

  // usage counted based on snapText
  cardsBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("Paste content into the main text box first.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    cardsResult.textContent = "Thinking...";

    try {
      if (typeof runFlashcards !== "function") {
        throw new Error(
          "runFlashcards() is not defined. Check your TASK HELPERS section."
        );
      }

      const ans = await runFlashcards(text);
      const answerText = typeof ans === "string" ? ans : String(ans ?? "");

      // show raw so you can copy/debug if needed
      cardsResult.textContent = answerText;

      const parsed = parseFlashcardsFromText(answerText);
      if (!parsed.length) {
        cardsViewer.style.display = "none";
        alert("I couldn't detect any Q/A pairs in the AI output.");
        addNotebookItem("Cards", answerText);
        return;
      }

      flashcards = parsed;
      currentCardIndex = 0;
      saveFlashcards(flashcards);
      renderCurrentCard();

      addNotebookItem("Cards", answerText);
    } catch (err) {
      console.error("Flashcards error:", err);
      cardsResult.textContent = "‚ö†Ô∏è Flashcards error: " + err.message;
    }
  });

  cardsClearBtn.addEventListener("click", () => {
    cardsResult.textContent = "";
    flashcards = [];
    currentCardIndex = 0;
    showingBack = false;
    saveFlashcards(flashcards);
    if (cardsViewer) cardsViewer.style.display = "none";
  });

  cardsFlipBtn.addEventListener("click", () => {
    if (!flashcards.length) return;
    showingBack = !showingBack;
    cardsFront.style.display = showingBack ? "none" : "block";
    cardsBack.style.display = showingBack ? "block" : "none";
  });

  function goToNextCard() {
    if (!flashcards.length) return;
    currentCardIndex = (currentCardIndex + 1) % flashcards.length;
    renderCurrentCard();
  }

  cardsGotItBtn.addEventListener("click", () => {
    if (!flashcards.length) return;
    const card = flashcards[currentCardIndex];
    card.status = "got";
    card.seen = (card.seen || 0) + 1;
    card.correct = (card.correct || 0) + 1;
    card.lastSeen = Date.now();
    saveFlashcards(flashcards);
    goToNextCard();
  });

  cardsNeedWorkBtn.addEventListener("click", () => {
    if (!flashcards.length) return;
    const card = flashcards[currentCardIndex];
    card.status = "need_work";
    card.seen = (card.seen || 0) + 1;
    card.lastSeen = Date.now();
    saveFlashcards(flashcards);
    goToNextCard();
  });
</script>

<!-- BLOCK 8: Quiz tab UI wiring -->
<script>
  // QUIZ
  const quizInput = document.getElementById("quizInput");
  const quizBtn = document.getElementById("quizBtn");
  const quizClearBtn = document.getElementById("quizClearBtn");
  const quizResult = document.getElementById("quizResult");

  // usage counted based on snapText
  quizBtn.addEventListener("click", async () => {
    const text = snapText.value.trim();
    if (!text) {
      alert("Paste content into the main text box first.");
      return;
    }

    // usage gate
    if (window.__canUseAIOnce) {
      const allowed = await window.__canUseAIOnce();
      if (!allowed) return;
    } else if (window.__canUseAIOnceAnon && !window.__canUseAIOnceAnon()) {
      return;
    }

    quizResult.textContent = "Thinking...";
    const ans = await runQuiz(text);
    const clean = sanitizeAnswerText(ans);
    renderAnswer(quizResult, clean);   // üëà
    addNotebookItem("Quiz", clean);

  });

  quizClearBtn.addEventListener("click", () => {
    quizResult.textContent = "";
  });
</script>

<!-- BLOCK 9: Simplify + Hint ‚Äúpill‚Äù buttons -->
<script>
// SIMPLIFY + HINT BUTTONS (styled with renderAnswer)
document.querySelectorAll(".pill-button").forEach((btn) => {
  btn.addEventListener("click", async () => {
    // no counting here
    const action = btn.dataset.action;
    const targetId = btn.dataset.target;
    if (!action || !targetId) return;

    const outputEl = document.getElementById(targetId);
    if (!outputEl) return;

    // plain text version of whatever is currently shown
    const currentPlain = outputEl.textContent.trim();
    if (!currentPlain) {
      alert("Nothing to process yet.");
      return;
    }

    if (action === "simplify") {
      outputEl.textContent = "Simplifying...";
      const ans = await runSimplify(currentPlain);
      const clean = sanitizeAnswerText(ans);
      renderAnswer(outputEl, clean);
      addNotebookItem("Simplified", clean);
    } else if (action === "hint") {
      const questionText = snapText.value || mathInput.value || "";
      const ans = await runHint(questionText, currentPlain);
      const cleanHint = sanitizeAnswerText(ans);

      const combined = currentPlain + "\n\nHint:\n" + cleanHint;
      renderAnswer(outputEl, combined);
      addNotebookItem("Hint", cleanHint);
    }
  });
});
</script>

<!-- BLOCK X: Snap hint row ‚Äî send OCR text to other tools -->
<script>
  (function () {
    const snapText = document.getElementById("snapText");

    function wireSnapAction(buttonId, inputId, tabId) {
      const btn = document.getElementById(buttonId);
      const input = document.getElementById(inputId);
      if (!btn || !input) return;

      btn.addEventListener("click", () => {
        const text = snapText.value.trim();
        if (!text) {
          alert("No OCR text yet. Run OCR or type something first.");
          return;
        }
        input.value = text;

        // Switch to the corresponding tab if activateTab exists
        if (typeof activateTab === "function" && tabId) {
          activateTab(tabId);
        }
      });
    }

    // Now use the same action buttons that live in the Snap hint row
    wireSnapAction("mathSolveBtn", "mathInput", "math");
    wireSnapAction("studyGuideBtn", "studyInput", "study");
    wireSnapAction("essayBtn", "essayInput", "essay");
    wireSnapAction("cardsBtn", "cardsInput", "flashcards");
    wireSnapAction("quizBtn", "quizInput", "quiz");
  })();
</script>

<!-- BLOCK: Completion animations (non-invasive wrappers) -->
<script>
  (function () {
    function animatePulse(el) {
      if (!el) return;
      el.classList.remove("pulse-once");
      // force reflow so animation can retrigger
      void el.offsetWidth;
      el.classList.add("pulse-once");
    }

    // make available if you ever want to call it manually
    window.__animatePulse = animatePulse;

    // After OCR completes -> highlight snapText
    if (typeof window.runFakeOCR === "function") {
      const _runFakeOCR = window.runFakeOCR;
      window.runFakeOCR = async function (file) {
        const result = await _runFakeOCR(file);
        setTimeout(() => {
          const snapText = document.getElementById("snapText");
          animatePulse(snapText);
        }, 0);
        return result;
      };
    }

    // After Snap & Solve completes -> highlight snapResult
    if (typeof window.runSnapSolve === "function") {
      const _runSnapSolve = window.runSnapSolve;
      window.runSnapSolve = async function (text) {
        const result = await _runSnapSolve(text);
        setTimeout(() => {
          const snapResult = document.getElementById("snapResult");
          animatePulse(snapResult);
        }, 0);
        return result;
      };
    }

    // After Math Solver -> highlight mathResult
    if (typeof window.runMathSolver === "function") {
      const _runMathSolver = window.runMathSolver;
      window.runMathSolver = async function (text) {
        const result = await _runMathSolver(text);
        setTimeout(() => {
          const el = document.getElementById("mathResult");
          animatePulse(el);
        }, 0);
        return result;
      };
    }

    // After Study Guide -> highlight studyResult
    if (typeof window.runStudyGuide === "function") {
      const _runStudyGuide = window.runStudyGuide;
      window.runStudyGuide = async function (text) {
        const result = await _runStudyGuide(text);
        setTimeout(() => {
          const el = document.getElementById("studyResult");
          animatePulse(el);
        }, 0);
        return result;
      };
    }

    // After Essay Helper -> highlight essayResult
    if (typeof window.runEssayHelper === "function") {
      const _runEssayHelper = window.runEssayHelper;
      window.runEssayHelper = async function (text) {
        const result = await _runEssayHelper(text);
        setTimeout(() => {
          const el = document.getElementById("essayResult");
          animatePulse(el);
        }, 0);
        return result;
      };
    }

    // After Quiz Maker -> highlight quizResult
    if (typeof window.runQuiz === "function") {
      const _runQuiz = window.runQuiz;
      window.runQuiz = async function (text) {
        const result = await _runQuiz(text);
        setTimeout(() => {
          const el = document.getElementById("quizResult");
          animatePulse(el);
        }, 0);
        return result;
      };
    }

    // After Flashcards generation -> highlight viewer (or raw result)
    if (typeof window.runFlashcards === "function") {
      const _runFlashcards = window.runFlashcards;
      window.runFlashcards = async function (text) {
        const result = await _runFlashcards(text);
        setTimeout(() => {
          const viewer = document.getElementById("cardsViewer");
          const resultEl = document.getElementById("cardsResult");
          animatePulse(viewer || resultEl);
        }, 0);
        return result;
      };
    }
  })();
</script>

<script>
  (function () {
    // in case __animatePulse isn't defined for some reason
    if (!window.__animatePulse) {
      window.__animatePulse = function (el) {
        if (!el) return;
        el.classList.remove("pulse-once");
        void el.offsetWidth;
        el.classList.add("pulse-once");
      };
    }

    // All the "big action" buttons (now all in Snap hint row + OCR)
    const buttons = document.querySelectorAll([
      "#snapOCRBtn",
      "#snapActionSolveBtn",
      "#mathSolveBtn",
      "#studyGuideBtn",
      "#essayBtn",
      "#cardsBtn",
      "#quizBtn"
    ].join(","));

    buttons.forEach((btn) => {
      if (!btn) return;
      btn.addEventListener("click", () => {
        window.__animatePulse(btn);
      });
    });
  })();
</script>

<script>
  (function () {
    // ---- Anonymous usage limiter (5 total uses before requiring login) ----

    const ANON_LIMIT = 5;
    const STORAGE_KEY = "passinggrade-anon-uses";

    // üîπ New: monthly free limit for logged-in users
    const FREE_MONTHLY_LIMIT = 10; // change this number whenever you want

    function getAnonUses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? parseInt(raw, 10) || 0 : 0;
      } catch {
        return 0;
      }
    }

    function setAnonUses(count) {
      try {
        localStorage.setItem(STORAGE_KEY, String(count));
      } catch {
        // ignore
      }
    }

    function showAnonLimitReached() {
      alert(
        "You‚Äôve used PassingGrade 5 times.\n\nTap ‚ÄòSign in‚Äô at the top right to create a free account and get 10 questions every month."
      );
    }

    // Call this before doing any AI action (for guests)
    function canUseAIOnceAnon() {
      const uses = getAnonUses();
      if (uses >= ANON_LIMIT) {
        showAnonLimitReached();
        return false;
      }
      setAnonUses(uses + 1);
      return true;
    }

    // Expose so we can call from existing handlers
    window.__canUseAIOnceAnon = canUseAIOnceAnon;

    // üîπ Auth-aware helper:
    // - Not logged in            -> use anon localStorage limiter
    // - Logged in & plan='pro'   -> unlimited, but still increments OCR usage
    // - Logged in & plan!='pro'  -> 10/month OCR limit using Supabase
    async function canUseAIOnce() {
      try {
        if (!window.supabaseClient) {
          // No Supabase client available, fall back to anon behavior
          return window.__canUseAIOnceAnon();
        }

        const {
          data: { user },
          error: userError,
        } = await window.supabaseClient.auth.getUser();

        if (userError || !user) {
          // Not logged in -> still use the anon localStorage limit
          return window.__canUseAIOnceAnon();
        }

        // üîπ Look up this user's plan from user_plans
        let isPaid = false;

        try {
          const { data: planRow, error: planError } = await window.supabaseClient
            .from("user_plans")
            .select("plan")
            .eq("user_id", user.id)
            .maybeSingle();

          if (planError) {
            console.error("error reading user_plans", planError);
          }

          const plan = planRow?.plan || "free";
          isPaid = plan === "pro";
        } catch (planEx) {
          console.error("exception reading user_plans", planEx);
        }

        // üîπ Pro plan -> no 10/month cap, but still track OCR usage
        if (isPaid) {
          const { error: rpcErrorPaid } = await window.supabaseClient.rpc(
            "increment_usage",
            {
              p_action: "ocr",
              p_amount: 1,
            }
          );

          if (rpcErrorPaid) {
            console.error(
              "increment_usage failed for paid user",
              rpcErrorPaid
            );
          }

          return true;
        }

        // üîπ Everyone else = 10/month OCR limit

        // Figure out the first day of this month as YYYY-MM-01
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const periodStart = `${now.getFullYear()}-${month}-01`;

        // Read this month's OCR usage row
        const { data: row, error: selectError } = await window.supabaseClient
          .from("usage_counters")
          .select("count")
          .eq("user_id", user.id)
          .eq("period_start", periodStart)
          .eq("action", "ocr")
          .maybeSingle();

        if (selectError) {
          console.error("error reading usage", selectError);
          // Don't block on read error ‚Äì allow and still try to increment
        }

        const currentCount = row?.count || 0;

        if (currentCount >= FREE_MONTHLY_LIMIT) {
          alert(
            "You‚Äôve used your " +
              FREE_MONTHLY_LIMIT +
              " free questions for this month.\n\nUpgrade your plan to keep using PassingGrade."
          );
          return false;
        }

        // Logged in and under limit -> bump OCR usage in Supabase
        const { error: rpcError } = await window.supabaseClient.rpc(
          "increment_usage",
          {
            p_action: "ocr",
            p_amount: 1,
          }
        );

        if (rpcError) {
          console.error("increment_usage failed", rpcError);
        }

        return true;
      } catch (err) {
        console.error("canUseAIOnce error", err);
        // On any error, don't break the app ‚Äì just allow usage
        return true;
      }
    }

    // Expose new async helper
    window.__canUseAIOnce = canUseAIOnce;
  })();
</script>






<!-- Supabase client library (from CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- PassingGrade auth setup (Supabase) -->
<script>
  const SUPABASE_URL = "https://rwjijfffirbpmkhcptrb.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3amlqZmZmaXJicG1raGNwdHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzYxNDgsImV4cCI6MjA4MDYxMjE0OH0.Lfv2HGMbdyyjF_SUA-7rWWN5XpvaLX8I36-upjH8_nQ";

  // Create a single Supabase client for the page
  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );
  window.supabaseClient = supabaseClient;

  // Test helper (manual)
  async function testIncrementUsage() {
    const { error } = await supabaseClient.rpc("increment_usage", {
      p_action: "ocr",
      p_amount: 1,
    });

    if (error) {
      console.error("increment_usage failed", error);
    } else {
      console.log("increment_usage succeeded");
    }
  }

  // Read current OCR usage for the logged-in user (console helper)
  async function showCurrentUsage() {
    const {
      data: { user },
      error: userError,
    } = await supabaseClient.auth.getUser();

    if (userError || !user) {
      console.error("no logged-in user", userError);
      return;
    }

    // First day of this month (dynamic)
    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const periodStart = `${now.getFullYear()}-${month}-01`;

    const { data, error } = await supabaseClient
      .from("usage_counters")
      .select("*")
      .eq("user_id", user.id)
      .eq("period_start", periodStart)
      .eq("action", "ocr")
      .maybeSingle();

    if (error) {
      console.error("error reading usage", error);
    } else {
      console.log("current usage row:", data);
    }
  }

  // --- handle OAuth tokens in URL (hash OR query) ---
  async function handleAuthFromUrl() {
    // Supabase / Google might put tokens in the hash (#...) or query (?...).
    const raw = window.location.hash || window.location.search || "";
    if (!raw) return;

    const qs = raw.replace(/^[#?]/, "");
    const params = new URLSearchParams(qs);
    const accessToken = params.get("access_token");
    const refreshToken = params.get("refresh_token");

    if (!accessToken || !refreshToken) return;

    try {
      await supabaseClient.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
      });

      // Clean the URL (remove tokens from address bar)
      window.history.replaceState(
        {},
        document.title,
        window.location.pathname + window.location.search
      );
    } catch (err) {
      console.error("Error setting session from OAuth redirect:", err);
    }
  }

  // Internal helper to read a specific user's plan
  async function fetchUserPlan(userId) {
    try {
      const { data, error } = await supabaseClient
        .from("user_plans")
        .select("plan")
        .eq("user_id", userId)
        .maybeSingle();

      if (error) {
        console.error("error loading user plan", error);
        return "free";
      }

      return data?.plan || "free";
    } catch (e) {
      console.error("fetchUserPlan exception", e);
      return "free";
    }
  }

  // Simple helper to update the header status text + button label
  async function updateAuthUI() {
    const userPlanLabel = document.getElementById("userPlanLabel");
    const authButton = document.getElementById("authButton");

    if (!userPlanLabel || !authButton) return;

    // Check if user is logged in
    const { data, error } = await supabaseClient.auth.getUser();

    // Not logged in
    if (error || !data.user) {
      userPlanLabel.textContent = "Guest ¬∑ 5 free OCR scans";
      authButton.textContent = "Sign in";
      authButton.dataset.authState = "signed-out";
      return;
    }

    const user = data.user;
    const email = user.email || "";
    const namePart = email.split("@")[0] || "your account";

    // Read plan from user_plans (free / pro)
    const plan = await fetchUserPlan(user.id);
    const isPro = plan === "pro";

    let usageText = "";

    try {
      // Same month logic as limiter: YYYY-MM-01
      const now = new Date();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const periodStart = `${now.getFullYear()}-${month}-01`;

      // Read this month's OCR usage row
      const { data: row, error: usageError } = await supabaseClient
        .from("usage_counters")
        .select("count")
        .eq("user_id", user.id)
        .eq("period_start", periodStart)
        .eq("action", "ocr")
        .maybeSingle();

      if (usageError) {
        console.error("usage label read error", usageError);
      }

      const currentCount = row?.count || 0;

      if (isPro) {
        // Pro: no /10 cap
        usageText = ` ¬∑ ${currentCount} OCR this month`;
      } else {
        // Free: show count out of 10
        usageText = ` ¬∑ ${currentCount}/10 OCR this month`;
      }
    } catch (e) {
      console.error("usage label exception", e);
    }

    // Build label: no "Pro plan" text for Pro users
    let label = `signed in as ${namePart}`;
    if (!isPro) {
      label = `Free plan ¬∑ ${label}`;
    }

    userPlanLabel.textContent = `${label}${usageText}`;
    authButton.textContent = "Sign out";
    authButton.dataset.authState = "signed-in";
  }

  // Handle click on the auth button (Sign in / Sign out) ‚Äì GOOGLE OAUTH
  async function handleAuthButtonClick() {
    const authButton = document.getElementById("authButton");
    if (!authButton) return;

    const state = authButton.dataset.authState || "signed-out";

    if (state === "signed-in") {
      // Sign out
      await supabaseClient.auth.signOut();
      await updateAuthUI();
      alert("Signed out.");
      return;
    }

    // Signed out ‚Üí Google OAuth sign-in
    try {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: {
          // Must match your Supabase Auth "Site URL"
          redirectTo: "https://passinggrade.app",
        },
      });

      if (error) {
        console.error("Google sign-in error:", error);
        alert("Error starting Google sign-in. Please try again.");
        return;
      }
    } catch (err) {
      console.error("OAuth error:", err);
      alert("Error starting sign-in. Please try again.");
    }
  }

  // Wire things up once the DOM is ready
  document.addEventListener("DOMContentLoaded", async () => {
    // 1) If we just came back from Google/Supabase, set the session
    await handleAuthFromUrl();

    // 2) Wire the button
    const authButton = document.getElementById("authButton");
    if (authButton) {
      authButton.addEventListener("click", handleAuthButtonClick);
    }

    // 3) Update header (will now see the session if it was set)
    updateAuthUI();
  });

  // Global helper: check the current logged-in user's plan (free/pro)
  window.getCurrentUserPlan = async function () {
    try {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data.user) {
        console.warn("no logged-in user for getCurrentUserPlan", error);
        return null;
      }

      const userId = data.user.id;
      return await fetchUserPlan(userId);
    } catch (e) {
      console.error("getCurrentUserPlan exception", e);
      return "free";
    }
  };
</script>









<script>
  document.addEventListener("DOMContentLoaded", () => {
    const upgradeBtn = document.getElementById("upgradeButton");
    const proBadge = document.getElementById("proBadge");

    // üîπ 1) Check plan on page load
    (async () => {
      try {
        const { data, error } = await supabaseClient.auth.getUser();
        if (error || !data.user) {
          // not logged in -> leave button visible, they can click & get "please sign in" message
          return;
        }

        const user = data.user;

        // Look up their plan by email
        // Look up their plan by user_id
const { data: planRow, error: planError } = await supabaseClient
  .from("user_plans")
  .select("plan")
  .eq("user_id", user.id)
  .maybeSingle();

        if (!planError && planRow && planRow.plan === "pro") {
          // ‚úÖ Already Pro: hide Upgrade button, show badge
          if (upgradeBtn) upgradeBtn.style.display = "none";
          if (proBadge) proBadge.style.display = "inline-block";
        }
      } catch (e) {
        console.error("Error checking user plan", e);
      }
    })();

    // üîπ 2) Upgrade click handler
    if (!upgradeBtn) return;

    upgradeBtn.addEventListener("click", async () => {
      // Require login
      try {
        const { data, error } = await supabaseClient.auth.getUser();

        if (error || !data.user) {
          alert("Please sign in first before upgrading to Pro.");
          return;
        }
      } catch (e) {
        console.error("Error checking auth before upgrade", e);
        alert("Could not verify your login. Please sign in again and try.");
        return;
      }

      const originalText = upgradeBtn.textContent;
      upgradeBtn.disabled = true;
      upgradeBtn.textContent = "Opening checkout...";

      try {
        const res = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        if (!res.ok) {
          throw new Error("Network error: " + res.status);
        }

        const data = await res.json();
        if (!data.url) {
          throw new Error("No checkout URL returned");
        }

        window.location.href = data.url;
      } catch (err) {
        console.error("Upgrade error", err);
        alert("Could not start checkout. Please try again in a moment.");
        upgradeBtn.disabled = false;
        upgradeBtn.textContent = originalText;
      }
    });
  });
</script>



</body>



</html>
